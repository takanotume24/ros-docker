name: Crystal CI

on: [push]

jobs:
  build-base-images:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tags:
          - "catkin-base"
          - "catkin-base-with-nvidia"

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
  
    - name: Build and push Docker images
      uses: docker/build-push-action@v1
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        repository: takanotume24/ros-docker
        dockerfile: "${{ matrix.tags }}/Dockerfile"
        always_pull: true
        add_git_labels: true
        tags: ${{ env.latest-tag}}, ${{ env.sha-tag }}
      env:
        latest-tag: "${{ matrix.tags }}-latest"
        sha-tag: "${{ matrix.tags }}-$GITHUB_SHA"
           
  build-extra-images:
    runs-on: ubuntu-latest
    needs: build-base-images
    strategy:
      matrix:
        tags:
          - "airsim"
          - "pedsim-ros-base"

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Build and push Docker images
      uses: docker/build-push-action@v1
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        repository: takanotume24/ros-docker
        dockerfile: "${{ matrix.tags }}/Dockerfile"
        always_pull: true
        add_git_labels: true
        tags: ${{ env.latest-tag}}, ${{ env.sha-tag }}
      env:
        latest-tag: "${{ matrix.tags }}-latest"
        sha-tag: "${{ matrix.tags }}-$GITHUB_SHA"